# 09 Docker复杂安装详说

## 1. 安装MySQL主从复制
搭建主从两个MySQL容器，实现主从复制。

### 1. 主从复制原理
默认懂，略过(其实我不懂)

### 2. 主从搭建步骤
**Step 1. 新建主服务器容器实例3307**
```shell
docker run -p 3307:3306 --name mysql-master \
-v /tmp/mydata/mysql-master/log:/var/log/mysql \
-v /tmp/mydata/mysql-master/data:/var/lib/mysql \
-v /tmp/mydata/mysql-master/conf:/etc/mysql/conf.d \
-e MYSQL_ROOT_PASSWORD=123456 \
-d mysql:5.7
```
1. 课件中给的命令中给的目录有个错误的地方，不是`/etc/mysql`，而是`/etc/mysql/conf.d`。否则会报`mysqld: Can't read dir of '/etc/mysql/conf.d/' (Errcode: 2 - No such file or directory)`的错误
2. host(3307) --> mysql-master(3306)
3. `log/`, `data/`, `conf/`目录分别对应日志，数据和配置目录，都使用local的目录以便即使容器销毁后也能保存数据。

**Step 2. 进入`/tmp/mysata/mysql-master/conf`目录下，新建`my.cnf`**
在`conf/`目录下创建`my.cnf`，添加对MySQL的配置。在local添加或修改配置后，需要重启才能生效。

本机的文件路径是`/tmp/mydata/mysql-master/conf/my.cnf`
```shell
[mysqld]
## 设置server_id，同一局域网中需要唯一
server_id=101
## 指定不需要同步的数据库名称
binlog-ignore-db=mysql
## 开启二进制日志功能
log-bin=mall-mysql-bin
## 设置二进制日志使用内存大小（事务）
binlog_cache_size=1M
## 设置使用的二进制日志格式（mixed,statement,row）
binlog_format=mixed
## 二进制日志过期清理时间。默认值为0，表示不自动清理。
expire_logs_days=7
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
```

**Step 3. 修改完配置后，重启mysal-master实例**
```shell
docker restart mysql-master
```

**Step 4. 进入mysql-master实例，登录MySQL**
进入mysql-master容器，并登陆MySQL
```shell
docker exec -it mysql-master /bin/bash

bash-4.2# mysql -uroot -p 

mysql> show databases;
```

**Step 5. 在mysql-master容器内创建同步用户**
```shell
CREATE USER 'slave'@'%' IDENTIFIED BY 'salve123456';
CREATE USER IF NOT EXISTS 'slave'@'%' IDENTIFIED BY 'salve123456';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';

# Run in mysql
# 创建slave用户
mysql> CREATE USER IF NOT EXISTS 'slave'@'%' IDENTIFIED BY 'salve123456';
Query OK, 0 rows affected, 1 warning (0.00 sec)

# 收于slave用户权限
mysql> GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';
Query OK, 0 rows affected (0.00 sec)
```

**Step 6. 新建从服务器容器实例3308**
新建从服务器，mysql-slave，使用主机的端口3308
```shell
docker run -p 3308:3306 --name mysql-slave \
-v /tmp/mydata/mysql-slave/log:/var/log/mysql \
-v /tmp/mydata/mysql-slave/data:/var/lib/mysql \
-v /tmp/mydata/mysql-slave/conf:/etc/mysql/conf.d \
-e MYSQL_ROOT_PASSWORD=123456 \
-d mysql:5.7
```

**Step 7. 进入`/tmp/mydata/mysql-slave/conf`目录下，新建`my.cnf`**
本机的文件路径是`/tmp/mydata/mysql-slave/conf/my.cnf`
```shell
[mysqld]
## 设置server_id，同一局域网中需要唯一
server_id=102
## 指定不需要同步的数据库名称
binlog-ignore-db=mysql
## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用
log-bin=mall-mysql-slave1-bin
## 设置二进制日志使用内存大小（事务）
binlog_cache_size=1M
## 设置使用的二进制日志格式（mixed,statement,row）
binlog_format=mixed
## 二进制日志过期清理时间。默认值为0，表示不自动清理。
expire_logs_days=7
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
## relay_log配置中继日志
relay_log=mall-mysql-relay-bin
## log_slave_updates表示slave将复制事件写进自己的二进制日志
log_slave_updates=1
## slave设置为只读（具有super权限的用户除外）
read_only=1
```

**Step 8. 修改完配置后，重启`mysql-slave`实例**
```shell
docker restart mysql-slave
```

**Step 9. 在主数据库中查看主从同步状态**
从**主**数据库(master)中查看
```shell
mysql> show master status;
+-----------------------+----------+--------------+------------------+-------------------+
| File                  | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-----------------------+----------+--------------+------------------+-------------------+
| mall-mysql-bin.000001 |      631 |              | mysql            |                   |
+-----------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
```

**Step 10. 进入`mysql-slave`容器实例**
```shell
docker exec -it mysql-slave bash

mysql -u root -p
```

**Step 11. 在从数据库中配置主从复制**
在**从**数据库(slave)中配置
拜码头，确认master
```shell
change master to master_host='宿主机ip', master_user='slave', master_password='123456', master_port=3307, master_log_file='mall-mysql-bin.000001', master_log_pos=617, master_connect_retry=30;
```

```shell
mysql> change master to master_host='192.168.68.59', master_user='slave', master_password='salve123456', master_port=3307, master_log_file='mall-mysql-bin.000001', master_log_pos=631, master_connect_retry=30;
Query OK, 0 rows affected, 2 warnings (0.01 sec)
```
参数说明:
* master_host：主数据库的IP地址；
* master_port：主数据库的运行端口；
* master_user：在主数据库创建的用于同步数据的用户账号；
* master_password：在主数据库创建的用于同步数据的用户密码；
* master_log_file：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取File参数；
* master_log_pos：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取Position参数；
* master_connect_retry：连接失败重试的时间间隔，单位为秒。


通过`ifconfig`命令，查找宿主机IP地址
```shell
 ~ ifconfig
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> mtu 16384
        options=1203<RXCSUM,TXCSUM,TXSTATUS,SW_TIMESTAMP>
        inet 127.0.0.1 netmask 0xff000000 
        inet6 ::1 prefixlen 128 
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1 
        nd6 options=201<PERFORMNUD,DAD>
gif0: flags=8010<POINTOPOINT,MULTICAST> mtu 1280
stf0: flags=0<> mtu 1280
en1: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
        options=400<CHANNEL_IO>
        ether b8:09:8a:50:fd:42 
        inet6 fe80::cef:dc45:29bc:4d00%en1 prefixlen 64 secured scopeid 0x4 
        inet 192.168.68.59 netmask 0xfffffc00 broadcast 192.168.71.255
        inet6 fdfe:dbb5:67aa:4bd8:188f:fc76:9827:c84c prefixlen 64 autoconf secured 
        inet6 2603:8000:4301:a0f::1001 prefixlen 128 dynamic 
        nd6 options=201<PERFORMNUD,DAD>
        media: autoselect
        status: active
en0: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
        options=40b<RXCSUM,TXCSUM,VLAN_HWTAGGING,CHANNEL_IO>
        ether c8:7f:54:66:e6:2f 
        nd6 options=201<PERFORMNUD,DAD>
        media: autoselect (<unknown type>)
        status: inactive
awdl0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> mtu 1484
        options=400<CHANNEL_IO>
        ether d6:d3:ee:4f:78:cd 
        inet6 fe80::d4d3:eeff:fe4f:78cd%awdl0 prefixlen 64 scopeid 0x6 
        nd6 options=201<PERFORMNUD,DAD>
        media: autoselect
        status: active
llw0: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
        options=400<CHANNEL_IO>
        ether d6:d3:ee:4f:78:cd 
        inet6 fe80::d4d3:eeff:fe4f:78cd%llw0 prefixlen 64 scopeid 0x7 
        nd6 options=201<PERFORMNUD,DAD>
        media: autoselect
        status: active
utun0: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1380
        inet6 fe80::535a:df47:7e93:a01e%utun0 prefixlen 64 scopeid 0x8 
        nd6 options=201<PERFORMNUD,DAD>
utun1: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 2000
        inet6 fe80::2fd:f9f6:cc21:afa%utun1 prefixlen 64 scopeid 0x9 
        nd6 options=201<PERFORMNUD,DAD>
utun2: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1000
        inet6 fe80::ce81:b1c:bd2c:69e%utun2 prefixlen 64 scopeid 0xa 
        nd6 options=201<PERFORMNUD,DAD>
utun3: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1380
        inet6 fe80::ac91:9cb1:1e5:d7ff%utun3 prefixlen 64 scopeid 0xb 
        nd6 options=201<PERFORMNUD,DAD>
utun4: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1380
        inet6 fe80::5647:5e83:1f82:6e0e%utun4 prefixlen 64 scopeid 0xc 
        nd6 options=201<PERFORMNUD,DAD>
➜  ~ 
```
IP地址是en1对应的`inet 192.168.68.59`

**Step 12. 在从数据库中查看主从同步状态**
```shell
mysql> show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: 
                  Master_Host: 192.168.68.59
                  Master_User: slave
                  Master_Port: 3307
                Connect_Retry: 30
              Master_Log_File: mall-mysql-bin.000001
          Read_Master_Log_Pos: 631
               Relay_Log_File: mall-mysql-relay-bin.000001
                Relay_Log_Pos: 4
        Relay_Master_Log_File: mall-mysql-bin.000001
             Slave_IO_Running: No
            Slave_SQL_Running: No
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 631
              Relay_Log_Space: 154
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: NULL
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 0
                  Master_UUID: 
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: 
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: 
No query specified
```
注意 line 213， 214
```shell
Slave_IO_Running: No
Slave_SQL_Running: No
```
此时都是No，因为master还没开始给slave写入任何东西。

or
```shell
mysql> show slave status;
+----------------+---------------+-------------+-------------+---------------+-----------------------+---------------------+-----------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+-------------+----------------------------+-----------+---------------------+-------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+
| Slave_IO_State | Master_Host   | Master_User | Master_Port | Connect_Retry | Master_Log_File       | Read_Master_Log_Pos | Relay_Log_File              | Relay_Log_Pos | Relay_Master_Log_File | Slave_IO_Running | Slave_SQL_Running | Replicate_Do_DB | Replicate_Ignore_DB | Replicate_Do_Table | Replicate_Ignore_Table | Replicate_Wild_Do_Table | Replicate_Wild_Ignore_Table | Last_Errno | Last_Error | Skip_Counter | Exec_Master_Log_Pos | Relay_Log_Space | Until_Condition | Until_Log_File | Until_Log_Pos | Master_SSL_Allowed | Master_SSL_CA_File | Master_SSL_CA_Path | Master_SSL_Cert | Master_SSL_Cipher | Master_SSL_Key | Seconds_Behind_Master | Master_SSL_Verify_Server_Cert | Last_IO_Errno | Last_IO_Error | Last_SQL_Errno | Last_SQL_Error | Replicate_Ignore_Server_Ids | Master_Server_Id | Master_UUID | Master_Info_File           | SQL_Delay | SQL_Remaining_Delay | Slave_SQL_Running_State | Master_Retry_Count | Master_Bind | Last_IO_Error_Timestamp | Last_SQL_Error_Timestamp | Master_SSL_Crl | Master_SSL_Crlpath | Retrieved_Gtid_Set | Executed_Gtid_Set | Auto_Position | Replicate_Rewrite_DB | Channel_Name | Master_TLS_Version |
+----------------+---------------+-------------+-------------+---------------+-----------------------+---------------------+-----------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+-------------+----------------------------+-----------+---------------------+-------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+
|                | 192.168.68.59 | slave       |        3307 |            30 | mall-mysql-bin.000001 |                 631 | mall-mysql-relay-bin.000001 |             4 | mall-mysql-bin.000001 | No               | No                |                 |                     |                    |                        |                         |                             |          0 |            |            0 |                 631 |             154 | None            |                |             0 | No                 |                    |                    |                 |                   |                |                  NULL | No                            |             0 |               |              0 |                |                             |                0 |             | /var/lib/mysql/master.info |         0 |                NULL |                         |              86400 |             |                         |                          |                |                    |                    |                   |             0 |                      |              |                    |
+----------------+---------------+-------------+-------------+---------------+-----------------------+---------------------+-----------------------------+---------------+-----------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+-------------+----------------------------+-----------+---------------------+-------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+
1 row in set (0.00 sec)
```


**Step 13. 在从数据库中开启中从同步**
```shell
mysql> start slave;
Query OK, 0 rows affected (0.00 sec)
```

**Step 14. 查看从数据库状态是否开始同步**
```shell
mysql> show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 192.168.68.59
                  Master_User: slave
                  Master_Port: 3307
                Connect_Retry: 30
              Master_Log_File: mall-mysql-bin.000001
          Read_Master_Log_Pos: 631
               Relay_Log_File: mall-mysql-relay-bin.000002
                Relay_Log_Pos: 325
        Relay_Master_Log_File: mall-mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 631
              Relay_Log_Space: 537
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 101
                  Master_UUID: 3e2a5f1e-3bf9-11ee-a9b3-0242ac110002
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: 
No query specified
```
此时
```shell
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
```

**Step 15. 测试主从复制**
1. 主机新建库，使用库，新建表，插入数据
2. 从机使用库，查看记录

```shell
# mysql-master
create database db01;
use db01;
create table t1 (id int, name varchar(20));
insert into t1 values(1, 'z3');
select * from t1;
```

在从数据库中，查看记录
```shell
# mysql-slave
use db01;
mysql> select * from t1;
+------+------+
| id   | name |
+------+------+
|    1 | z3   |
+------+------+
1 row in set (0.00 sec)
```


## 2. 安装redis集群








---
## Appendix
### `ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)`
```shell
bash-4.2# mysql -uroot -p 
Enter password: 
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)
```
After removing `/tmp/mydata`, and then restart a new container, the `mysql -uroot -p` works.

* [MYSQL_ROOT_PASSWORD is set but getting "Access denied for user 'root'@'localhost' (using password: YES)" in docker container](https://stackoverflow.com/questions/59838692/mysql-root-password-is-set-but-getting-access-denied-for-user-rootlocalhost)
* https://stackoverflow.com/a/59839180 
